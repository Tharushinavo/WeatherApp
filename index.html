<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Weather Forecast with Interactive Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        :root {
            --primary-color: #3498db; --secondary-color: #2980b9; --light-color: #ecf0f1; --dark-color: #2c3e50;
            --green: #2ecc71; --green-dark: #27ae60; --orange: #e67e22; --orange-dark: #d35400;
            --red: #e74c3c; --red-dark: #c0392b; --yellow: #f1c40f; --yellow-dark: #d4b30a;
            --grey: #95a5a6; --grey-dark: #7f8c8d; --border-radius: 10px; --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        body { background: linear-gradient(135deg,#74b9ff,#0984e3); color:var(--dark-color); min-height:100vh; padding:20px; transition:var(--transition);}
        body.dark-mode { background: linear-gradient(135deg,#2d3436,#636e72); color:var(--light-color); }
        .container { max-width:1200px; margin:0 auto; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:20px; background-color: rgba(255,255,255,0.9); border-radius:var(--border-radius); box-shadow:var(--box-shadow); transition:var(--transition); }
        body.dark-mode header { background-color: rgba(44,62,80,0.9); }
        .logo { display:flex; align-items:center; gap:10px; font-size:1.5rem; font-weight:700; color:var(--primary-color); }
        .logo i { font-size:2rem; }
        .controls { display:flex; gap:15px; }
        button { padding:10px 15px; border:none; border-radius:var(--border-radius); background-color:var(--primary-color); color:white; cursor:pointer; font-weight:600; transition:var(--transition); display:flex; align-items:center; gap:8px; }
        button:hover { transform: translateY(-2px); }
        #location-btn { background-color: var(--green); }
        #location-btn:hover { background-color: var(--green-dark); }
        #favorite-btn { background-color: var(--orange); } #favorite-btn:hover { background-color: var(--orange-dark); }
        #map-temperature { background-color: var(--red); } #map-temperature:hover{ background-color:var(--red-dark); }
        #map-precipitation { background-color: var(--yellow); color:#2c3e50; } #map-precipitation:hover{ background-color:var(--yellow-dark); color:#2c3e50; }
        #map-wind { background-color: var(--grey); } #map-wind:hover{ background-color:var(--grey-dark); }
        #clear-favorites { background-color: var(--red); } #clear-favorites:hover{ background-color:var(--red-dark); }
        .search-container { display:flex; gap:10px; margin-bottom:30px; }
        input[type="text"] { flex:1; padding:15px; border:none; border-radius:var(--border-radius); font-size:1rem; box-shadow:var(--box-shadow); transition:var(--transition); }
        body.dark-mode input[type="text"] { background-color: rgba(44,62,80,0.8); color:var(--light-color); }
        input[type="text"]:focus { outline:2px solid var(--primary-color); }
        .main-content { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
        @media (max-width:768px) { .main-content { grid-template-columns:1fr; } }
        .current-weather { background-color: rgba(255,255,255,0.9); border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); transition:var(--transition); }
        body.dark-mode .current-weather { background-color: rgba(44,62,80,0.9); }
        .weather-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .location { font-size:1.8rem; font-weight:700; }
        .date { color:#7f8c8d; font-size:1rem; }
        .weather-main { display:flex; align-items:center; gap:20px; margin-bottom:30px; }
        .temperature { font-size:4rem; font-weight:700; }
        .weather-icon { font-size:5rem; color:var(--primary-color); }
        .weather-description { font-size:1.5rem; text-transform:capitalize; }
        .weather-details { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .detail-item { display:flex; align-items:center; gap:10px; padding:15px; background-color: rgba(236,240,241,0.7); border-radius:var(--border-radius); transition:var(--transition); }
        body.dark-mode .detail-item { background-color: rgba(52,73,94,0.7); }
        .detail-item i { font-size:1.5rem; color:var(--primary-color); }
        .detail-info h3 { font-size:0.9rem; color:#7f8c8d; }
        .detail-info p { font-size:1.2rem; font-weight:600; }
        .forecast { background-color: rgba(255,255,255,0.9); border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); transition:var(--transition); }
        body.dark-mode .forecast { background-color: rgba(44,62,80,0.9); }
        .forecast h2 { margin-bottom:20px; font-size:1.5rem; }
        .forecast-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
        .forecast-item { display:flex; flex-direction:column; align-items:center; padding:15px; background-color: rgba(236,240,241,0.7); border-radius:var(--border-radius); transition:var(--transition); }
        body.dark-mode .forecast-item { background-color: rgba(52,73,94,0.7); }
        .forecast-day { font-weight:600; margin-bottom:10px; }
        .forecast-icon { font-size:2rem; color:var(--primary-color); margin-bottom:10px; }
        .forecast-temp { font-weight:600; }
        .favorites { margin-top:30px; background-color: rgba(255,255,255,0.9); border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); transition:var(--transition); }
        body.dark-mode .favorites { background-color: rgba(44,62,80,0.9); }
        .favorites-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .favorites-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; }
        .favorite-item { display:flex; justify-content:space-between; align-items:center; padding:15px; background-color: rgba(236,240,241,0.7); border-radius:var(--border-radius); transition:var(--transition); }
        body.dark-mode .favorite-item { background-color: rgba(52,73,94,0.7); }
        .favorite-info h3 { font-size:1.1rem; font-weight:600; }
        .favorite-info p { font-size:0.9rem; color:#7f8c8d; }
        .alert { position:fixed; top:20px; right:20px; padding:15px 20px; background-color:var(--warning-color); color:white; border-radius:var(--border-radius); box-shadow:var(--box-shadow); display:flex; align-items:center; gap:10px; z-index:1000; transform:translateX(150%); transition: transform 0.5s ease; }
        .alert.show { transform: translateX(0); }
        .map-container { margin-top:30px; background-color: rgba(255,255,255,0.9); border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); transition:var(--transition); height:500px; }
        body.dark-mode .map-container { background-color: rgba(44,62,80,0.9); }
        #weather-map { height: 80%; width:100%; border-radius:var(--border-radius); z-index:1; }
        .map-controls { display:flex; gap:10px; margin-bottom:15px; }
        .map-controls button { padding:8px 12px; font-size:0.9rem; }
        .map-legend { display:flex; flex-wrap:wrap; gap:15px; margin-top:15px; padding:10px; background-color: rgba(255,255,255,0.8); border-radius:var(--border-radius); }
        body.dark-mode .map-legend { background-color: rgba(44,62,80,0.8); }
        .legend-item { display:flex; align-items:center; gap:5px; font-size:0.8rem; }
        .legend-color { width:15px; height:15px; border-radius:50%; }
        .hidden { display:none; }
        .loading { display:flex; justify-content:center; align-items:center; height:200px; }
        .spinner { width:50px; height:50px; border:5px solid rgba(52,152,219,0.3); border-radius:50%; border-top-color:var(--primary-color); animation:spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .leaflet-popup-content { text-align:center; }
        .weather-popup { padding:10px; }
        .popup-temperature { font-size:1.5rem; font-weight:bold; margin:5px 0; }
        .popup-description { text-transform:capitalize; margin-bottom:5px; }
        .popup-details { font-size:0.8rem; color:#666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-cloud-sun"></i>
                <span>Weather Forecast</span>
            </div>
            <div class="controls">
                <button id="location-btn">
                    <i class="fas fa-location-arrow"></i>
                    My Location
                </button>
                <button id="theme-toggle">
                    <i class="fas fa-moon"></i>
                    Dark Mode
                </button>
            </div>
        </header>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search for a city...">
            <button id="search-btn">
                <i class="fas fa-search"></i>
                Search
            </button>
        </div>

        <div class="main-content">
            <div class="current-weather">
                <div class="weather-header">
                    <div>
                        <h1 class="location">New York, US</h1>
                        <p class="date">Monday, November 17, 2025</p>
                    </div>
                    <button id="favorite-btn">
                        <i class="far fa-star"></i>
                        Add to Favorites
                    </button>
                </div>
                <div class="weather-main">
                    <div class="temperature">22°C</div>
                    <div>
                        <i class="fas fa-sun weather-icon"></i>
                        <p class="weather-description">Sunny</p>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="detail-item">
                        <i class="fas fa-wind"></i>
                        <div class="detail-info">
                            <h3>Wind Speed</h3>
                            <p>5 km/h</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-tint"></i>
                        <div class="detail-info">
                            <h3>Humidity</h3>
                            <p>65%</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-temperature-low"></i>
                        <div class="detail-info">
                            <h3>Feels Like</h3>
                            <p>24°C</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-compress-arrows-alt"></i>
                        <div class="detail-info">
                            <h3>Pressure</h3>
                            <p>1015 hPa</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="forecast">
                <h2>5-Day Forecast</h2>
                <div class="forecast-list">
                    <!-- forecast items will be inserted here -->
                </div>
            </div>
        </div>

        <div class="favorites">
            <div class="favorites-header">
                <h2>Favorite Locations</h2>
                <button id="clear-favorites">
                    <i class="fas fa-trash"></i>
                    Clear All
                </button>
            </div>
            <div class="favorites-list">
                <div class="favorite-item">
                    <div class="favorite-info">
                        <h3>London, UK</h3>
                        <p>15°C, Cloudy</p>
                    </div>
                    <button class="remove-favorite">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="favorite-item">
                    <div class="favorite-info">
                        <h3>Tokyo, JP</h3>
                        <p>18°C, Rainy</p>
                    </div>
                    <button class="remove-favorite">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="map-container">
            <h2>Interactive Weather Map</h2>
            <div class="map-controls">
                <button id="map-temperature">
                    <i class="fas fa-thermometer-half"></i>
                    Temperature
                </button>
                <button id="map-precipitation">
                    <i class="fas fa-cloud-rain"></i>
                    Precipitation
                </button>
                <button id="map-wind">
                    <i class="fas fa-wind"></i>
                    Wind
                </button>
                <button id="map-clouds">
                    <i class="fas fa-cloud"></i>
                    Cloud Cover
                </button>
            </div>
            <div id="weather-map"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #313695"></div>
                    <span>Very Cold</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4575b4"></div>
                    <span>Cold</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #74add1"></div>
                    <span>Cool</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #abd9e9"></div>
                    <span>Mild</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e0f3f8"></div>
                    <span>Warm</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #fee090"></div>
                    <span>Hot</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #fdae61"></div>
                    <span>Very Hot</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f46d43"></div>
                    <span>Extreme Heat</span>
                </div>
            </div>
        </div>
    </div>

    <div class="alert" id="weather-alert">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>Weather Alert!</strong>
            <p>Severe thunderstorm warning in your area.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
       
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const locationBtn = document.getElementById('location-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const favoriteBtn = document.getElementById('favorite-btn');
        const clearFavoritesBtn = document.getElementById('clear-favorites');
        const weatherAlert = document.getElementById('weather-alert');
        const body = document.body;
        const mapTemperatureBtn = document.getElementById('map-temperature');
        const mapPrecipitationBtn = document.getElementById('map-precipitation');
        const mapWindBtn = document.getElementById('map-wind');
        const mapCloudsBtn = document.getElementById('map-clouds');

        
        let map;
        let currentLayer = 'temperature';
        let markers = [];
        let userMarker = null;
        let favorites = JSON.parse(localStorage.getItem('weatherFavorites')) || [];

       
        function initMap() {
            map = L.map('weather-map').setView([40.7128, -74.0060], 3);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            addWeatherLayer('temperature');

            map.on('click', function(e) {
            
                getWeatherByCoords(e.latlng.lat, e.latlng.lng);
            });
        }

        function addWeatherLayer(layerType) {
            clearMarkers(); 
            currentLayer = layerType;
            updateActiveMapButton(layerType === 'temperature' ? mapTemperatureBtn :
                                  layerType === 'precipitation' ? mapPrecipitationBtn :
                                  layerType === 'wind' ? mapWindBtn : mapCloudsBtn);

            if (layerType === 'temperature') addTemperatureMarkers();
            else if (layerType === 'precipitation') addPrecipitationMarkers();
            else if (layerType === 'wind') addWindMarkers();
            else addCloudMarkers();
        }

        function updateActiveMapButton(activeButton) {
          
            mapTemperatureBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--red').trim();
            mapPrecipitationBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim();
            mapPrecipitationBtn.style.color = '#2c3e50';
            mapWindBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--grey').trim();
            mapCloudsBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
            mapCloudsBtn.style.color = 'white';

            if (activeButton === mapTemperatureBtn) activeButton.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--red-dark').trim();
            if (activeButton === mapPrecipitationBtn) { activeButton.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--yellow-dark').trim(); activeButton.style.color = '#2c3e50'; }
            if (activeButton === mapWindBtn) activeButton.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--grey-dark').trim();
            if (activeButton === mapCloudsBtn) activeButton.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim();
        }

        
        function addTemperatureMarkers() {
            clearMarkers();
            const cities = [
                { name: "New York", lat: 40.7128, lng: -74.0060, temp: 22 },
                { name: "London", lat: 51.5074, lng: -0.1278, temp: 15 },
                { name: "Tokyo", lat: 35.6762, lng: 139.6503, temp: 18 },
                { name: "Sydney", lat: -33.8688, lng: 151.2093, temp: 25 },
                { name: "Moscow", lat: 55.7558, lng: 37.6173, temp: 5 },
                { name: "Cairo", lat: 30.0444, lng: 31.2357, temp: 30 },
                { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, temp: 28 },
                { name: "Mumbai", lat: 19.0760, lng: 72.8777, temp: 32 }
            ];

            cities.forEach(city => {
                const temp = city.temp;
                let color;
                if (temp < 0) color = '#313695';
                else if (temp < 10) color = '#4575b4';
                else if (temp < 15) color = '#74add1';
                else if (temp < 20) color = '#abd9e9';
                else if (temp < 25) color = '#e0f3f8';
                else if (temp < 30) color = '#fee090';
                else if (temp < 35) color = '#fdae61';
                else color = '#f46d43';

                const icon = L.divIcon({
                    className: 'temperature-marker',
                    html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">${temp}°</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([city.lat, city.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="weather-popup">
                            <h3>${city.name}</h3>
                            <div class="popup-temperature">${temp}°C</div>
                            <div class="popup-description">${getWeatherDescription(temp)}</div>
                            <div class="popup-details">Click for detailed forecast</div>
                        </div>
                    `);

                markers.push(marker);

                marker.on('click', function() {
                    getWeatherByCoords(city.lat, city.lng);
                });
            });
        }

        function addPrecipitationMarkers() {
            clearMarkers();
            const cities = [
                { name: "New York", lat: 40.7128, lng: -74.0060, precip: 10 },
                { name: "London", lat: 51.5074, lng: -0.1278, precip: 80 },
                { name: "Tokyo", lat: 35.6762, lng: 139.6503, precip: 60 },
                { name: "Sydney", lat: -33.8688, lng: 151.2093, precip: 5 },
                { name: "Moscow", lat: 55.7558, lng: 37.6173, precip: 30 },
                { name: "Cairo", lat: 30.0444, lng: 31.2357, precip: 0 },
                { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, precip: 20 },
                { name: "Mumbai", lat: 19.0760, lng: 72.8777, precip: 70 }
            ];

            cities.forEach(city => {
                const precip = city.precip;
                let color, iconClass;
                if (precip === 0) { color = '#ffffcc'; iconClass = 'fas fa-sun'; }
                else if (precip < 20) { color = '#a1dab4'; iconClass = 'fas fa-cloud-sun'; }
                else if (precip < 40) { color = '#41b6c4'; iconClass = 'fas fa-cloud'; }
                else if (precip < 60) { color = '#2c7fb8'; iconClass = 'fas fa-cloud-rain'; }
                else { color = '#253494'; iconClass = 'fas fa-cloud-showers-heavy'; }

                const icon = L.divIcon({
                    className: 'precipitation-marker',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white;"><i class="${iconClass}"></i></div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([city.lat, city.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="weather-popup">
                            <h3>${city.name}</h3>
                            <div class="popup-temperature">${precip}% precipitation</div>
                            <div class="popup-description">${getPrecipitationDescription(precip)}</div>
                            <div class="popup-details">Click for detailed forecast</div>
                        </div>
                    `);

                markers.push(marker);

                marker.on('click', function() {
                    getWeatherByCoords(city.lat, city.lng);
                });
            });
        }

        function addWindMarkers() {
            clearMarkers();
            const cities = [
                { name: "New York", lat: 40.7128, lng: -74.0060, windSpeed: 5, windDir: 45 },
                { name: "London", lat: 51.5074, lng: -0.1278, windSpeed: 12, windDir: 180 },
                { name: "Tokyo", lat: 35.6762, lng: 139.6503, windSpeed: 8, windDir: 90 },
                { name: "Sydney", lat: -33.8688, lng: 151.2093, windSpeed: 15, windDir: 270 },
                { name: "Moscow", lat: 55.7558, lng: 37.6173, windSpeed: 3, windDir: 0 },
                { name: "Cairo", lat: 30.0444, lng: 31.2357, windSpeed: 10, windDir: 135 },
                { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, windSpeed: 7, windDir: 225 },
                { name: "Mumbai", lat: 19.0760, lng: 72.8777, windSpeed: 6, windDir: 315 }
            ];

            cities.forEach(city => {
                const speed = city.windSpeed;
                const dir = city.windDir;
                let color;
                if (speed < 5) color = '#ffffb2';
                else if (speed < 10) color = '#fed976';
                else if (speed < 15) color = '#feb24c';
                else if (speed < 20) color = '#fd8d3c';
                else color = '#f03b20';

                const icon = L.divIcon({
                    className: 'wind-marker',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; transform: rotate(${dir}deg);"><i class="fas fa-location-arrow"></i></div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([city.lat, city.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="weather-popup">
                            <h3>${city.name}</h3>
                            <div class="popup-temperature">${speed} km/h</div>
                            <div class="popup-description">Wind speed</div>
                            <div class="popup-details">Direction: ${getWindDirection(dir)}</div>
                        </div>
                    `);

                markers.push(marker);

                marker.on('click', function() {
                    getWeatherByCoords(city.lat, city.lng);
                });
            });
        }

        function addCloudMarkers() {
            clearMarkers();
            const cities = [
                { name: "New York", lat: 40.7128, lng: -74.0060, clouds: 20 },
                { name: "London", lat: 51.5074, lng: -0.1278, clouds: 80 },
                { name: "Tokyo", lat: 35.6762, lng: 139.6503, clouds: 60 },
                { name: "Sydney", lat: -33.8688, lng: 151.2093, clouds: 10 },
                { name: "Moscow", lat: 55.7558, lng: 37.6173, clouds: 90 },
                { name: "Cairo", lat: 30.0444, lng: 31.2357, clouds: 5 },
                { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, clouds: 30 },
                { name: "Mumbai", lat: 19.0760, lng: 72.8777, clouds: 70 }
            ];

            cities.forEach(city => {
                const clouds = city.clouds;
                let color;
                if (clouds < 20) color = '#f7fcf0';
                else if (clouds < 40) color = '#e0f3db';
                else if (clouds < 60) color = '#ccebc5';
                else if (clouds < 80) color = '#a8ddb5';
                else color = '#7bccc4';

                const icon = L.divIcon({
                    className: 'cloud-marker',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: #333;"><i class="fas fa-cloud"></i></div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([city.lat, city.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="weather-popup">
                            <h3>${city.name}</h3>
                            <div class="popup-temperature">${clouds}%</div>
                            <div class="popup-description">Cloud cover</div>
                            <div class="popup-details">${getCloudDescription(clouds)}</div>
                        </div>
                    `);

                markers.push(marker);

                marker.on('click', function() {
                    getWeatherByCoords(city.lat, city.lng);
                });
            });
        }

        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        /* --- small helpers for UI text --- */
        function getWeatherDescription(temp) {
            if (temp < 0) return "Freezing";
            if (temp < 10) return "Cold";
            if (temp < 15) return "Cool";
            if (temp < 20) return "Mild";
            if (temp < 25) return "Warm";
            if (temp < 30) return "Hot";
            return "Very Hot";
        }
        function getPrecipitationDescription(precip) {
            if (precip === 0) return "No precipitation";
            if (precip < 20) return "Light rain possible";
            if (precip < 40) return "Chance of rain";
            if (precip < 60) return "Rain likely";
            return "Heavy rain expected";
        }
        function getWindDirection(degrees) {
            const directions = ['N','NE','E','SE','S','SW','W','NW'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }
        function getCloudDescription(clouds) {
            if (clouds < 20) return "Clear skies";
            if (clouds < 40) return "Partly cloudy";
            if (clouds < 60) return "Mostly cloudy";
            if (clouds < 80) return "Cloudy";
            return "Overcast";
        }

      
        async function reverseGeocode(lat, lon) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
                if (!res.ok) throw new Error('Reverse geocode failed');
                const data = await res.json();
                const address = data.address || {};
                
                return address.city || address.town || address.village || address.county || address.state || data.display_name || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
            } catch (err) {
                console.warn('Reverse geocode error', err);
                return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
            }
        }

        async function fetchWeatherFromOpenMeteo(lat, lon) {
            try {
                
                const params = new URLSearchParams({
                    latitude: lat,
                    longitude: lon,
                    current_weather: 'true',
                    daily: 'temperature_2m_max,temperature_2m_min,weathercode',
                    timezone: 'auto'
                });
                const url = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Open-Meteo fetch failed');
                const data = await res.json();

               
                const wcodeMap = {
                    0: {icon: 'fa-sun', desc: 'Clear'},
                    1: {icon: 'fa-cloud-sun', desc: 'Mainly clear'},
                    2: {icon: 'fa-cloud-sun', desc: 'Partly cloudy'},
                    3: {icon: 'fa-cloud', desc: 'Overcast'},
                    45: {icon: 'fa-smog', desc: 'Fog'},
                    48: {icon: 'fa-smog', desc: 'Depositing rime fog'},
                    51: {icon: 'fa-cloud-rain', desc: 'Light drizzle'},
                    53: {icon: 'fa-cloud-rain', desc: 'Moderate drizzle'},
                    55: {icon: 'fa-cloud-rain', desc: 'Dense drizzle'},
                    61: {icon: 'fa-cloud-showers-heavy', desc: 'Slight rain'},
                    63: {icon: 'fa-cloud-showers-heavy', desc: 'Moderate rain'},
                    65: {icon: 'fa-cloud-showers-heavy', desc: 'Heavy rain'},
                    71: {icon: 'fa-snowflake', desc: 'Snow'},
                    80: {icon: 'fa-cloud-showers-heavy', desc: 'Rain showers'},
                   
                    default: {icon: 'fa-cloud', desc: 'Weather'}
                };

                const cw = data.current_weather || {};
                const temp = cw.temperature ?? null;
                const wind = cw.windspeed ?? null;
                const wcode = cw.weathercode ?? null;
                const codeEntry = wcodeMap[wcode] || wcodeMap.default;

                const forecast = [];
                if (data.daily && Array.isArray(data.daily.time)) {
                    const times = data.daily.time;
                    const tmax = data.daily.temperature_2m_max || [];
                    const tmin = data.daily.temperature_2m_min || [];
                    const wcodes = data.daily.weathercode || [];
                    for (let i = 0; i < Math.min(5, times.length); i++) {
                        const day = new Date(times[i]);
                        const dayName = day.toLocaleDateString(undefined, { weekday: 'short' });
                        const code = wcodes[i];
                        const entr = wcodeMap[code] || wcodeMap.default;
                        forecast.push({ day: dayName, icon: entr.icon, temp: `${Math.round(tmax[i])}° / ${Math.round(tmin[i])}°` });
                    }
                }

                return {
                    temperature: temp !== null ? `${Math.round(temp)}°C` : 'N/A',
                    description: (wcodeMap[wcode] && wcodeMap[wcode].desc) || (temp !== null ? getWeatherDescription(temp) : 'N/A'),
                    icon: codeEntry.icon,
                    wind: wind !== null ? `${Math.round(wind)} km/h` : 'N/A',
                    humidity: 'N/A', 
                    feelsLike: 'N/A',
                    pressure: 'N/A',
                    forecast
                };
            } catch (err) {
                console.error('fetchWeatherFromOpenMeteo error', err);
                return null;
            }
        }

        
        async function getCurrentLocation_real() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            locationBtn.disabled = true;
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

               
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([lat, lon], {
                    radius: 8,
                    color: '#2ecc71',
                    fillColor: '#2ecc71',
                    fillOpacity: 0.9
                }).addTo(map).bindPopup('You are here').openPopup();

                map.setView([lat, lon], 10);

            
                const placeName = await reverseGeocode(lat, lon);

                
                const weather = await fetchWeatherFromOpenMeteo(lat, lon);
                if (weather) {
                   
                    const weatherData = {
                        location: placeName,
                        temperature: weather.temperature,
                        description: weather.description,
                        icon: weather.icon,
                        wind: weather.wind,
                        humidity: weather.humidity,
                        feelsLike: weather.feelsLike,
                        pressure: weather.pressure,
                        forecast: weather.forecast.length ? weather.forecast : [
                            { day: 'Today', icon: weather.icon, temp: weather.temperature }
                        ]
                    };
                    updateWeatherDisplay(weatherData);
                } else {
                   
                    document.querySelector('.location').textContent = placeName;
                }

                locationBtn.disabled = false;
                locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> My Location';
            }, (err) => {
                alert('Unable to retrieve your location. Please allow location access or try again.');
                console.warn('geolocation error', err);
                locationBtn.disabled = false;
                locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> My Location';
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        async function getWeatherByCoords(lat, lon) {
           
            if (userMarker) {
               
            }
            const sel = L.marker([lat, lon]).addTo(map);
            setTimeout(() => map.removeLayer(sel), 5000); 

            const placeName = await reverseGeocode(lat, lon);
            const weather = await fetchWeatherFromOpenMeteo(lat, lon);

            if (weather) {
                const weatherData = {
                    location: placeName,
                    temperature: weather.temperature,
                    description: weather.description,
                    icon: weather.icon,
                    wind: weather.wind,
                    humidity: weather.humidity,
                    feelsLike: weather.feelsLike,
                    pressure: weather.pressure,
                    forecast: weather.forecast.length ? weather.forecast : [{ day: 'Today', icon: weather.icon, temp: weather.temperature }]
                };
                updateWeatherDisplay(weatherData);
            } else {
                alert('Could not fetch weather for this location.');
            }
        }

     

        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });

        locationBtn.addEventListener('click', () => {
       
            getCurrentLocation_real();
        });

        themeToggle.addEventListener('click', toggleTheme);
        favoriteBtn.addEventListener('click', toggleFavorite);
        clearFavoritesBtn.addEventListener('click', clearFavorites);

        mapTemperatureBtn.addEventListener('click', () => addWeatherLayer('temperature'));
        mapPrecipitationBtn.addEventListener('click', () => addWeatherLayer('precipitation'));
        mapWindBtn.addEventListener('click', () => addWeatherLayer('wind'));
        mapCloudsBtn.addEventListener('click', () => addWeatherLayer('clouds'));

        initMap();
        updateFavoritesDisplay();
        showWeatherAlert();


        const sampleWeatherData = {
            'New York': {
                location: 'New York, US',
                temperature: '22°C',
                description: 'Sunny',
                icon: 'fa-sun',
                wind: '5 km/h',
                humidity: '65%',
                feelsLike: '24°C',
                pressure: '1015 hPa',
                forecast: [
                    { day: 'Tue', icon: 'fa-cloud-sun', temp: '24°C' },
                    { day: 'Wed', icon: 'fa-cloud', temp: '20°C' },
                    { day: 'Thu', icon: 'fa-cloud-rain', temp: '18°C' },
                    { day: 'Fri', icon: 'fa-sun', temp: '25°C' },
                    { day: 'Sat', icon: 'fa-cloud-sun', temp: '23°C' }
                ]
            },
            'London': {
                location: 'London, UK',
                temperature: '15°C',
                description: 'Cloudy',
                icon: 'fa-cloud',
                wind: '12 km/h',
                humidity: '78%',
                feelsLike: '14°C',
                pressure: '1008 hPa',
                forecast: [
                    { day: 'Tue', icon: 'fa-cloud', temp: '16°C' },
                    { day: 'Wed', icon: 'fa-cloud-rain', temp: '14°C' },
                    { day: 'Thu', icon: 'fa-cloud-rain', temp: '13°C' },
                    { day: 'Fri', icon: 'fa-cloud-sun', temp: '17°C' },
                    { day: 'Sat', icon: 'fa-cloud', temp: '15°C' }
                ]
            },
            'Tokyo': {
                location: 'Tokyo, JP',
                temperature: '18°C',
                description: 'Rainy',
                icon: 'fa-cloud-rain',
                wind: '8 km/h',
                humidity: '85%',
                feelsLike: '17°C',
                pressure: '1012 hPa',
                forecast: [
                    { day: 'Tue', icon: 'fa-cloud-rain', temp: '17°C' },
                    { day: 'Wed', icon: 'fa-cloud', temp: '19°C' },
                    { day: 'Thu', icon: 'fa-cloud-sun', temp: '21°C' },
                    { day: 'Fri', icon: 'fa-sun', temp: '23°C' },
                    { day: 'Sat', icon: 'fa-sun', temp: '24°C' }
                ]
            }
        };

        function handleSearch() {
            const query = searchInput.value.trim();
            if (query) {
                if (sampleWeatherData[query]) {
                    updateWeatherDisplay(sampleWeatherData[query]);
                    centerMapOnLocation(query);
                } else {
                    alert(`Weather data for "${query}" not found in demo. Try New York, London, or Tokyo, or click "My Location" to use real location.`);
                }
            }
        }

        function centerMapOnLocation(location) {
            const coordinates = {
                'New York': [40.7128, -74.0060],
                'London': [51.5074, -0.1278],
                'Tokyo': [35.6762, 139.6503]
            };

            if (coordinates[location]) {
                map.setView(coordinates[location], 8);
            }
        }

        function toggleTheme() {
            body.classList.toggle('dark-mode');
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                icon.className = 'fas fa-moon';
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
        }

        function toggleFavorite() {
            const location = document.querySelector('.location').textContent;
            const index = favorites.findIndex(fav => fav.location === location);

            if (index === -1) {
                const weatherData = getCurrentWeatherData();
                favorites.push(weatherData);
                updateFavoriteButton(true);
            } else {
                favorites.splice(index, 1);
                updateFavoriteButton(false);
            }

            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
            updateFavoritesDisplay();
        }

        function getCurrentWeatherData() {
            return {
                location: document.querySelector('.location').textContent,
                temperature: document.querySelector('.temperature').textContent,
                description: document.querySelector('.weather-description').textContent
            };
        }

        function updateFavoriteButton(isFavorite) {
            const icon = favoriteBtn.querySelector('i');
            if (isFavorite) {
                icon.className = 'fas fa-star';
                favoriteBtn.innerHTML = '<i class="fas fa-star"></i> Remove Favorite';
            } else {
                icon.className = 'far fa-star';
                favoriteBtn.innerHTML = '<i class="far fa-star"></i> Add to Favorites';
            }
        }

        function clearFavorites() {
            if (confirm("Are you sure you want to clear all favorites?")) {
                favorites = [];
                localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                updateFavoritesDisplay();
            }
        }

        function updateFavoritesDisplay() {
            const favoritesList = document.querySelector('.favorites-list');
            favoritesList.innerHTML = '';

            if (favorites.length === 0) {
                favoritesList.innerHTML = '<p>No favorite locations yet.</p>';
                return;
            }

            favorites.forEach((fav, index) => {
                const favoriteItem = document.createElement('div');
                favoriteItem.className = 'favorite-item';
                favoriteItem.innerHTML = `
                    <div class="favorite-info">
                        <h3>${fav.location}</h3>
                        <p>${fav.temperature}, ${fav.description}</p>
                    </div>
                    <button class="remove-favorite" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                favoritesList.appendChild(favoriteItem);
            });

            document.querySelectorAll('.remove-favorite').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    favorites.splice(index, 1);
                    localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                    updateFavoritesDisplay();
                });
            });
        }

        function updateWeatherDisplay(weatherData) {
         
            document.querySelector('.location').textContent = weatherData.location || 'Unknown location';

            const today = new Date();
            document.querySelector('.date').textContent = today.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });

            document.querySelector('.temperature').textContent = weatherData.temperature || 'N/A';
            document.querySelector('.weather-description').textContent = weatherData.description || 'N/A';

            const weatherIcon = document.querySelector('.weather-icon');
          
            weatherIcon.className = `fas ${weatherData.icon || 'fa-cloud-sun'} weather-icon`;

            document.querySelectorAll('.detail-item')[0].querySelector('p').textContent = weatherData.wind || 'N/A';
            document.querySelectorAll('.detail-item')[1].querySelector('p').textContent = weatherData.humidity || 'N/A';
            document.querySelectorAll('.detail-item')[2].querySelector('p').textContent = weatherData.feelsLike || 'N/A';
            document.querySelectorAll('.detail-item')[3].querySelector('p').textContent = weatherData.pressure || 'N/A';

            const forecastList = document.querySelector('.forecast-list');
            forecastList.innerHTML = '';

            (weatherData.forecast || []).forEach(day => {
                const forecastItem = document.createElement('div');
                forecastItem.className = 'forecast-item';
                forecastItem.innerHTML = `
                    <div class="forecast-day">${day.day}</div>
                    <i class="fas ${day.icon} forecast-icon"></i>
                    <div class="forecast-temp">${day.temp}</div>
                `;
                forecastList.appendChild(forecastItem);
            });

            const isFavorite = favorites.some(fav => fav.location === weatherData.location);
            updateFavoriteButton(isFavorite);
        }

        function showWeatherAlert() {
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    weatherAlert.classList.add('show');
                    setTimeout(() => {
                        weatherAlert.classList.remove('show');
                    }, 5000);
                }, 2000);
            }
        }

    </script>
</body>
</html>
